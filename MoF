#! /usr/bin/zsh

picturesdir="$HOME/Pictures/"
musicdir="$HOME/Music/"
videosdir="$HOME/Videos/"
documentsdir="$HOME/Documents/"
blenderdir="/media/spare/blender stuff/blender/blender voice"

# lists
pictures=()
musics=()
videos=()
documents=()
blenders=()

# Define color variables
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
MAGENTA='\033[35m'
CYAN='\033[36m'
RESET='\033[0m'

# Default values
LOCAL=false
SUBFILES=false
SMART=false
VERBOSE=false
FLATTEN=false
blender=false
TARGET_DIR="."


CONFIG_FILE="$HOME/.config/MoF.conf"

if [[ -f "$CONFIG_FILE" ]]; then
  source "$CONFIG_FILE"
else
  echo "${YELLOW}[WARN] No config file found at $CONFIG_FILE${RESET}"
fi

Show_help() {
  echo
  echo "MoF - Media Organizer"
  echo "  Organizes files by type"
  echo "Usage: Mof [options] [Directory]"
  echo
  echo "Options:"
  echo "  -h,  --help       Show this messsage"
  echo "  -l,  --local      Place sorted files into local folders instead of system folders"
  echo "  -s,  --subfiles   Include subfiles in search"
  echo "  -sf, --smartfind  Only include folders if all their subfolders contain one media type only"
  echo "  -v,  --verbose    More detailed output"
  echo "  -f,  --flatten    Flatten file system (ignores file structure)"
  echo "  -b,  --blender    FOR ME hehe"
  echo
  echo "Notes:"
  echo " - If no directory is specifed the current directory is used (can be changed in config)"
}

# Scan options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      Show_help
      exit 0
      ;;
    -l|--local)
      LOCAL=true
      shift
      ;;
    -s|--subfiles)
      SUBFILES=true
      shift
      ;;
    -sf|--smartfind)
      SMART=true
      shift
      ;;
    -v|--VERBOSE)
      VERBOSE=true
      shift
      ;;
    -f|--flatten)
      FLATTEN=true
      shift
      ;;
    -*)
      Show_help
      echo
      echo $RED"Unknown option: $1 $RESET"
      exit 1
      ;;
    *)
      # asume its the spescifed directory
      TARGET_DIR="$1"
      shift
      ;;
  esac
done

if $VERBOSE; then 
  echo $CYAN"[DETAIL] Directory: $TARGET_DIR"
  echo $GREEN"[DETAIL] Scanning directory"
fi

classify_file() {
  local file="$1"
  case "$file" in
    *.jpg|*.jpeg|*.png|*.gif) 
      pictures+=("$file")
      $VERBOSE && echo $GREEN"[FOUND]   $file${RESET}"
      ;;
    *.mp3|*.wav|*.flac|*.ogg) 
      musics+=("$file")
      $VERBOSE && echo $GREEN"[FOUND]   $file${RESET}"
      ;;
    *.mp4|*.mkv|*.webm) 
      videos+=("$file")
      $VERBOSE && echo $GREEN"[FOUND]   $file${RESET}"
      ;;
    *.pdf|*.txt|*.docx|*.epub) 
      documents+=("$file")
      $VERBOSE && echo $GREEN"[FOUND]   $file${RESET}"
      ;;
    *.blend1|*.blend)
      if $blender; then 
        blenders+=("$file")
        $VERBOSE && echo $GREEN"[FOUND]   $file${RESET}"
      fi
      ;;
  esac
}



search() {
  folders=()

  if $SUBFILES; then
    while IFS= read -r -d '' dir; do
      folders+=("$dir")
    done < <(find "$TARGET_DIR" -type d -print0)
  fi


  for file in "$TARGET_DIR"/*; do
     classify_file() $file
  done

  if $SUBFILES; then 
    for folder in $folders; then 
      for file in "${folders[@]}"; then
        classify_file() $file
      done
    done
  fi
}


smart_search() {
  folders=()

  if $SUBFILES; then
    while IFS= read -r -d '' dir; do
      folders+=("$dir")
    done < <(find "$TARGET_DIR" -type d -print0)
  else
    folders=("$TARGET_DIR")
  fi

  for folder in "${folders[@]}"; do
    pic=0
    mus=0
    vid=0
    doc=0
    blend=0
    other=0

    for file in "$folder"/*; do
      [[ -f "$file" ]] || continue

      case "$file" in
        *.jpg|*.jpeg|*.png|*.gif) ((pic++)) ;;
        *.mp3|*.wav|*.flac|*.ogg) ((mus++)) ;;
        *.mp4|*.mkv|*.webm) ((vid++)) ;;
        *.pdf|*.txt|*.docx|*.epub) ((doc++)) ;;
        *.blend1|*.blend) ((blend++)) ;;
        *) ((other++)) ;;
      esac
    done

    total=$((pic + mus + vid + doc + blend + other))

    if ((total == 0)); then
      continue  # skip empty folders
    fi

    if ((pic == total)); then
      for file in "$folder"/*; do pictures+=("$file"); done
      $VERBOSE && echo $MAGENTA"[SMART] Pictures folder: $folder${RESET}"
    elif ((mus == total)); then
      for file in "$folder"/*; do musics+=("$file"); done
      $VERBOSE && echo $MAGENTA"[SMART] Music folder: $folder${RESET}"
    elif ((vid == total)); then
      for file in "$folder"/*; do videos+=("$file"); done
      $VERBOSE && echo $MAGENTA"[SMART] Videos folder: $folder${RESET}"
    elif ((doc == total)); then
      for file in "$folder"/*; do documents+=("$file"); done
      $VERBOSE && echo $MAGENTA"[SMART] Documents folder: $folder${RESET}"
    elif ((blend == total && $blender)); then
      for file in "$folder"/*; do blenders+=("$file"); done
      $VERBOSE && echo $MAGENTA"[SMART] Blender folder: $folder${RESET}"
    fi
  done
}
